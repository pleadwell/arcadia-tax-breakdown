<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Arcadia Residential Property Tax Breakdown</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0d6efd" />
  <link rel="icon" href="logo.svg" type="image/svg+xml" />
  <!-- Open Graph for richer Facebook previews -->
  <meta property="og:title" content="Arcadia Residential Property Tax Breakdown" />
  <meta property="og:description" content="Pick your specific ward, enter your annual property tax bill, and see how your property tax dollars are being spent across the 12 budget categories. The totals match your bill to the penny." />
  <!-- Optional: if you have a 1200x630 preview image, add: -->
  <!-- <meta property="og:image" content="https://your-domain.example/og-image.jpg" /> -->

  <style>
    :root{
      --bg:#f7f8fa; --surface:#ffffff; --ink:#1f2937; --muted:#6b7280; --accent:#0d6efd; --border:#e5e7eb;
      --radius:12px; --shadow:0 6px 20px rgba(0,0,0,.06);
    }
    * { box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    .wrap{ max-width:860px; margin:32px auto; padding:0 16px; }
    header{ margin-bottom:16px; }
    h1{ font-size:clamp(22px,3.8vw,30px); margin:0 0 6px; }
    p.lead{ color:var(--muted); margin:0 0 16px; }
    .card{ background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; }
    .grid{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media (min-width:720px){ .grid{ grid-template-columns: 1fr 1fr auto } }

    label{ font-weight:600; font-size:14px; display:block; margin-bottom:6px; }
    select, input[type="text"]{
      width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; font-size:16px;
    }
    .actions{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    button{
      border:0; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer;
    }
    .primary{ background:var(--accent); color:#fff; }
    .ghost{ background:#fff; border:1px solid var(--border); color:var(--ink); }
    .info{ color:#0b6b2f; background:#e8f5ec; border:1px solid #cce9d6; padding:10px 12px; border-radius:10px; }
    .warn{ color:#7a2e0e; background:#fff7ed; border:1px solid #ffedd5; padding:10px 12px; border-radius:10px; }

    table{ width:100%; border-collapse:collapse; margin-top:6px; }
    th, td{ padding:10px 8px; border-bottom:1px solid var(--border); text-align:left; }
    th{ background:#f9fafb; font-size:14px; }
    tr:last-child td{ border-bottom:0; }
    .right{ text-align:right; white-space:nowrap; }
    .bar{
      height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; width:100%; position:relative;
    }
    .bar > span{
      position:absolute; left:0; top:0; bottom:0; width:0%;
      background:var(--accent);
    }
    tfoot td{ font-weight:700; }

    .tools{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
    .muted{ color:var(--muted); font-size:13px; }
    .footer{ color:var(--muted); margin-top:18px; font-size:13px; }
    .hidden{ display:none !important; }

    /* --- Brand header with logo --- */
    header.brand { display:flex; align-items:center; gap:12px; }
    .brand-logo { display:inline-flex; align-items:center; }
    .brand-logo img.logo {
      display:block;
      width:48px; height:48px;
      object-fit:contain;
    }
    @media (max-width:480px){
      .brand-logo img.logo { width:40px; height:40px; }
    }

    /* Contact area */
    .contact { margin-top:12px; display:grid; gap:8px; }
    .contact .row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
    .pill{ background:#f1f5f9; border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:14px; }
    .contact .label{ font-weight:700; color:#111827; }
    .contact .address{ font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="brand">
      <div class="brand-logo">
        <img
          class="logo"
          src="./logo.svg"
          alt="Arcadia"
          width="48" height="48"
          decoding="async"
          fetchpriority="high"
          onerror="this.style.display='none'"/>
      </div>
      <div>
        <h1>Arcadia Residential Property Tax Breakdown</h1>
        <p class="lead">
          Pick your specific ward, enter your annual property tax bill, and see how your property tax dollars are being spent across the 12 budget categories. The totals match your bill to the penny.
        </p>
      </div>
    </header>

    <section class="card" aria-label="Inputs">
      <div class="grid">
        <div>
          <label for="ward">Ward</label>
          <select id="ward" name="ward" autocomplete="off">
            <option>Upper Gagetown (Ward 1)</option>
            <option>Gagetown (Ward 2)</option>
            <option>Hampstead (Ward 3)</option>
            <option>Cambridge (Ward 4)</option>
            <option>Cambridge Narrows (Ward 5)</option>
            <option>Waterborough (Ward 6)</option>
          </select>
        </div>
        <div>
          <label for="amount">Property tax bill (annual, CAD)</label>
          <input id="amount" name="amount" inputmode="decimal" placeholder="e.g., 2,400" />
        </div>
        <div class="actions" style="align-self:end;">
          <button class="primary" id="calcBtn" aria-label="Calculate breakdown">Calculate</button>
          <button class="ghost" id="resetBtn" aria-label="Reset inputs">Reset</button>
        </div>
      </div>
      <div id="msg" class="warn hidden" role="status" aria-live="polite"></div>
    </section>

    <section id="outCard" class="card hidden" aria-label="Results">
      <!-- (1) Grey summary boxes removed as requested -->

      <div class="tools">
        <!-- (2) Share on Facebook first; CSV removed; new PNG button added -->
        <button class="ghost" id="shareBtn">Share on Facebook</button>
        <button class="primary" id="emailBtn" title="Email your councillor & mayor">Email my councillor &amp; mayor</button>
        <button class="ghost" id="pngBtn" title="Download the table as an image">Download image (PNG)</button>
        <a id="linkBtn" class="ghost" href="#" target="_blank" style="display:inline-block; text-decoration:none; padding:10px 14px; border-radius:10px; border:1px solid var(--border);">Open shareable link</a>
        <button class="ghost" id="copyEmailBtn" title="Copy email text for manual paste">Copy email text</button>
        <button class="ghost" id="copyAddrsBtn" title="Copy email addresses">Copy email addresses</button>
        <button class="ghost" id="copyBtn" title="Copy a plain-text summary (optional)">Copy summary</button>
      </div>

      <!-- (3) Preface before Councillor area -->
      <p style="margin-top:10px;"><strong>You can send an email now to your Councillor, Mayor and the Arcadia office.</strong></p>

      <div class="contact">
        <div class="row">
          <span class="label">Councillor:</span>
          <span id="cName" class="pill">—</span>
          <span id="cEmail" class="pill address">—</span>
        </div>
        <div class="row">
          <span class="label">Mayor:</span>
          <span id="mName" class="pill">Clinton Sharpe</span>
          <span id="mEmail" class="pill address">clinton.sharpe@arcadianb.ca</span>
        </div>
        <div class="row">
          <span class="label">Queries CC list:</span>
          <span id="ccList" class="pill address">info@arcadianb.ca, Karrie.Bedford@arcadianb.ca, Jessica.Mcgarity@arcadianb.ca</span>
        </div>
        <p class="muted">Tip: After clicking “Download image (PNG)”, attach the image in your email app. Some devices can also paste images directly into the email body.</p>
      </div>

      <table id="resultsTable" aria-label="Breakdown table">
        <thead>
          <tr>
            <th>Budget Category</th>
            <th class="right">Percent</th>
            <th style="width:40%">Allocation</th>
            <th class="right">Amount (CAD)</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
        <tfoot>
          <tr>
            <td><strong>This is my Property Tax total</strong></td>
            <td class="right" id="totalPct">100%</td>
            <td></td>
            <td class="right" id="totalAmt">—</td>
          </tr>
        </tfoot>
      </table>

      <div id="note" class="info hidden" style="margin-top:10px;"></div>

      <div class="footer">
        ⚠️ Sample percentages included. Replace with your official splits when available. Rounding is distributed so the sum equals your exact bill.
      </div>
    </section>
  </div>

  <script>
    // ---------- Configuration ----------
    const WARD_DATA = {
      "Upper Gagetown (Ward 1)": {
        "Education": 20, "Public Safety": 15, "Infrastructure": 10, "Health": 5,
        "Parks": 5, "Transportation": 10, "Fire Services": 10, "Social Services": 5,
        "Administration": 5, "Debt Services": 10, "Environmental": 2.5, "Emergency": 2.5
      },
      "Gagetown (Ward 2)": {
        "Education": 18, "Public Safety": 17, "Infrastructure": 9, "Health": 6,
        "Parks": 6, "Transportation": 12, "Fire Services": 8, "Social Services": 6,
        "Administration": 5, "Debt Services": 10, "Environmental": 1.5, "Emergency": 1.5
      },
      "Hampstead (Ward 3)": {
        "Education": 22, "Public Safety": 13, "Infrastructure": 11, "Health": 4,
        "Parks": 4, "Transportation": 9, "Fire Services": 11, "Social Services": 4,
        "Administration": 6, "Debt Services": 10, "Environmental": 3, "Emergency": 3
      },
      "Cambridge (Ward 4)": {
        "Education": 19, "Public Safety": 16, "Infrastructure": 10, "Health": 5,
        "Parks": 5, "Transportation": 11, "Fire Services": 9, "Social Services": 5,
        "Administration": 5, "Debt Services": 10, "Environmental": 2.5, "Emergency": 2.5
      },
      "Cambridge Narrows (Ward 5)": {
        "Education": 21, "Public Safety": 14, "Infrastructure": 10, "Health": 5,
        "Parks": 6, "Transportation": 10, "Fire Services": 10, "Social Services": 5,
        "Administration": 5, "Debt Services": 10, "Environmental": 2, "Emergency": 2
      },
      "Waterborough (Ward 6)": {
        "Education": 20, "Public Safety": 15, "Infrastructure": 10, "Health": 5,
        "Parks": 5, "Transportation": 10, "Fire Services": 10, "Social Services": 5,
        "Administration": 5, "Debt Services": 10, "Environmental": 2.5, "Emergency": 2.5
      }
    };

    // Contacts
    const CONTACTS = {
      "Upper Gagetown (Ward 1)": { name: "Tammy Gordon", email: "tammy.gordon@arcadianb.ca" },
      "Gagetown (Ward 2)": { name: "Paul Mennier", email: "paul.mennier@arcadianb.ca" },
      "Hampstead (Ward 3)": { name: "Harry Thomson", email: "harry.thomson@arcadianb.ca" },
      "Cambridge (Ward 4)": { name: "Deputy Mayor Steven Sharpe", email: "steven.sharpe@arcadianb.ca" },
      "Cambridge Narrows (Ward 5)": { name: "Sheila Black", email: "Sheila.black@arcadianb.ca" },
      "Waterborough (Ward 6)": { name: "Paula Gahan-McGee", email: "Paula.gahan-magee@arcadianb.ca" }
    };
    const MAYOR = { name: "Clinton Sharpe", email: "clinton.sharpe@arcadianb.ca" };
    const QUERY_CC = ["info@arcadianb.ca", "Karrie.Bedford@arcadianb.ca", "Jessica.Mcgarity@arcadianb.ca"];

    // Back-compat for old links
    const LEGACY_WARD_ALIASES = {
      "Ward 1": "Upper Gagetown (Ward 1)",
      "Ward 2": "Gagetown (Ward 2)",
      "Ward 3": "Hampstead (Ward 3)",
      "Ward 4": "Cambridge (Ward 4)",
      "Ward 5": "Cambridge Narrows (Ward 5)",
      "Ward 6": "Waterborough (Ward 6)"
    };

    const LOCALE = 'en-CA';
    const CURRENCY = 'CAD';

    // ---------- Utilities ----------
    const $ = (sel) => document.querySelector(sel);
    const fmtMoney = (cents) =>
      new Intl.NumberFormat(LOCALE, { style:'currency', currency: CURRENCY, currencyDisplay:'symbol' })
        .format((cents||0)/100);

    const parseAmount = (s) => {
      if (typeof s !== 'string') return 0;
      s = s.trim().replace(/[^\d.,-]/g,'');            // strip $ and spaces
      if (s.includes(',') && s.includes('.')) s = s.replace(/,/g,'');   // 1,234.56
      else if (s.includes(',') && !s.includes('.')) s = s.replace(',', '.'); // 1234,56
      const num = Number(s);
      return isFinite(num) ? Math.max(0, Math.round(num * 100)) : 0;
    };

    function normalizePercents(obj){
      const entries = Object.entries(obj);
      const sum = entries.reduce((t,[,p]) => t + Number(p), 0);
      if (sum === 0) return entries.map(([k]) => [k, 0]);
      return entries.map(([k,p]) => [k, (Number(p) / sum) * 100]);
    }

    // Distribute rounding so total == bill to the penny
    function allocateCents(totalCents, percPairs){
      const raw = percPairs.map(([k,p]) => [k, (totalCents * (p/100))]);
      const floors = raw.map(([k,v]) => [k, Math.floor(v)]);
      const remainders = raw.map(([k,v],i) => [k, v - floors[i][1]]);
      let used = floors.reduce((t,[,c]) => t + c, 0);
      let need = Math.round(raw.reduce((t,[,v]) => t + v, 0)) - used;

      remainders.sort((a,b) => b[1] - a[1]);
      const outMap = new Map(floors);
      for (let i = 0; i < remainders.length && need > 0; i++, need--){
        const k = remainders[i][0];
        outMap.set(k, outMap.get(k) + 1);
      }
      return Array.from(outMap.entries()); // [[category, cents], ...]
    }

    function buildDeepLink(ward, amountCents){
      const url = new URL(window.location.href);
      url.searchParams.set('ward', ward);
      url.searchParams.set('amount', (amountCents/100).toString());
      url.searchParams.delete('currency');
      return url.toString();
    }

    function buildMailto(toList, ccList, subject, body){
      const params = new URLSearchParams();
      if (ccList && ccList.length) params.set('cc', ccList.join(','));
      params.set('subject', subject);
      params.set('body', body);
      return `mailto:${toList.join(',')}?${params.toString()}`;
    }

    // ---- Canvas export of the visual table to PNG (no external libs) ----
    function truncateToWidth(ctx, text, maxWidth){
      if (ctx.measureText(text).width <= maxWidth) return text;
      let ellipsis = '…', len = text.length;
      while (len > 0 && ctx.measureText(text.slice(0, len) + ellipsis).width > maxWidth) len--;
      return text.slice(0, len) + ellipsis;
    }

    async function generateTablePNG(ward, mergedRows, totalCents){
      const pad = 24;
      const rowH = 36;
      const headH = 44;
      const footH = 48;

      const colCat = 420;
      const colPct = 100;
      const colBar = 340;
      const colAmt = 160;

      const innerW = colCat + colPct + colBar + colAmt;
      const width = pad*2 + innerW;
      const height = pad + headH + (mergedRows.length * rowH) + footH + pad;

      const scale = Math.min(window.devicePixelRatio || 2, 3);
      const canvas = document.createElement('canvas');
      canvas.width = Math.round(width * scale);
      canvas.height = Math.round(height * scale);
      const ctx = canvas.getContext('2d');
      ctx.scale(scale, scale);

      // Background
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, width, height);

      // Fonts
      const fontMono = 'ui-monospace, SFMono-Regular, Menlo, Consolas, monospace';
      const fontSans = 'system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif';

      // Header row background
      ctx.fillStyle = '#f9fafb';
      ctx.fillRect(pad, pad, innerW, headH);

      // Header text
      ctx.fillStyle = '#111827';
      ctx.font = '700 16px ' + fontSans;
      let x = pad, y = pad + 28;
      ctx.fillText('Budget Category', x, y);
      x += colCat;
      ctx.fillText('Percent', x + colPct - ctx.measureText('Percent').width - 8, y);
      x += colPct;
      ctx.fillText('Allocation', x + 8, y);
      x += colBar;
      ctx.fillText('Amount (CAD)', x + colAmt - ctx.measureText('Amount (CAD)').width - 8, y);

      // Rows
      let baseY = pad + headH;
      for (const r of mergedRows){
        const yMid = baseY + rowH/2;
        let cx = pad;

        // Category
        ctx.fillStyle = '#111827';
        ctx.font = '500 14px ' + fontSans;
        const cat = truncateToWidth(ctx, r.category, colCat - 8);
        ctx.fillText(cat, cx + 4, yMid + 5);
        cx += colCat;

        // Percent
        ctx.textAlign = 'right';
        ctx.font = '500 14px ' + fontMono;
        ctx.fillText(r.percent.toFixed(2) + '%', cx + colPct - 4, yMid + 5);
        ctx.textAlign = 'left';
        cx += colPct;

        // Bar
        const barY = yMid - 6;
        ctx.fillStyle = '#e5e7eb';
        ctx.fillRect(cx + 4, barY, colBar - 8, 12);
        ctx.fillStyle = '#0d6efd';
        const fillW = Math.max(0, (colBar - 8) * (r.percent / 100));
        ctx.fillRect(cx + 4, barY, fillW, 12);
        cx += colBar;

        // Amount
        ctx.textAlign = 'right';
        ctx.fillStyle = '#111827';
        ctx.font = '600 14px ' + fontMono;
        ctx.fillText(new Intl.NumberFormat('en-CA', {style:'currency', currency:'CAD'}).format(r.cents/100), cx + colAmt - 4, yMid + 5);
        ctx.textAlign = 'left';

        // Row divider
        ctx.strokeStyle = '#e5e7eb';
        ctx.beginPath();
        ctx.moveTo(pad, baseY + rowH);
        ctx.lineTo(pad + innerW, baseY + rowH);
        ctx.stroke();

        baseY += rowH;
      }

      // Footer (Total)
      ctx.fillStyle = '#111827';
      ctx.font = '700 14px ' + fontSans;
      ctx.fillText('This is my Property Tax total', pad + 4, baseY + 30);

      ctx.textAlign = 'right';
      ctx.font = '700 14px ' + fontMono;
      ctx.fillText(new Intl.NumberFormat('en-CA', {style:'currency', currency:'CAD'}).format(totalCents/100), pad + innerW - 4, baseY + 30);
      ctx.textAlign = 'left';

      // Outer border
      ctx.strokeStyle = '#e5e7eb';
      ctx.strokeRect(pad, pad, innerW, headH + (mergedRows.length * rowH) + footH);

      return new Promise(resolve => canvas.toBlob(blob => resolve({blob, canvas}), 'image/png'));
    }

    function downloadBlob(blob, filename){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(a.href), 5000);
    }

    // ---------- DOM & Events ----------
    const wardSel = $('#ward');
    const amtInput = $('#amount');
    const calcBtn = $('#calcBtn');
    const resetBtn = $('#resetBtn');

    const msg = $('#msg');
    const out = $('#outCard');
    const note = $('#note');
    const totalPct = $('#totalPct');
    const totalAmt = $('#totalAmt');
    const resultsBody = $('#resultsBody');

    const copyBtn = $('#copyBtn');
    const shareBtn= $('#shareBtn');
    const linkBtn = $('#linkBtn');
    const emailBtn = $('#emailBtn');
    const copyEmailBtn = $('#copyEmailBtn');
    const copyAddrsBtn = $('#copyAddrsBtn');
    const pngBtn = $('#pngBtn');

    const cName = $('#cName');
    const cEmail = $('#cEmail');
    const mName = $('#mName');
    const mEmail = $('#mEmail');
    const ccListEl = $('#ccList');

    let lastMergedForImage = null;
    let lastTotalCents = 0;
    let lastWardName = '';

    function computeAndRender(){
      const ward = wardSel.value;
      const amountCents = parseAmount(amtInput.value);

      if (!WARD_DATA[ward]) {
        showMsg("Ward not found.", true);
        out.classList.add('hidden');
        return;
      }
      if (!amountCents){
        showMsg("Enter a valid bill amount (e.g., 2400).", true);
        out.classList.add('hidden');
        return;
      }

      // Normalize percentages, warn if off 100
      const percPairsRaw = Object.entries(WARD_DATA[ward]);
      const normalized = normalizePercents(WARD_DATA[ward]);
      const sumRaw = percPairsRaw.reduce((t,[,p]) => t + Number(p), 0);

      const off = Math.abs(sumRaw - 100);
      if (off > 0.001){
        note.textContent = `Note: Ward percentages sum to ${sumRaw.toFixed(2)}%. Values have been normalized to 100%.`;
        note.classList.remove('hidden');
      } else {
        note.classList.add('hidden');
      }

      // Allocation with fair rounding
      const allocated = allocateCents(amountCents, normalized);

      // Merge & sort by percent (desc)
      const merged = allocated.map(([k,cents]) => {
        const p = normalized.find(([kk]) => kk===k)?.[1] ?? 0;
        return { category:k, percent:p, cents };
      }).sort((a,b) => b.percent - a.percent);

      // Update results table
      resultsBody.innerHTML = '';
      for (const row of merged){
        const tr = document.createElement('tr');

        const tdCat = document.createElement('td');
        tdCat.textContent = row.category;

        const tdPct = document.createElement('td');
        tdPct.className = 'right';
        tdPct.textContent = `${row.percent.toFixed(2)}%`;

        const tdBar = document.createElement('td');
        const bar = document.createElement('div');
        bar.className = 'bar';
        const fill = document.createElement('span');
        fill.style.width = `${row.percent.toFixed(6)}%`;
        bar.appendChild(fill);
        tdBar.appendChild(bar);

        const tdAmt = document.createElement('td');
        tdAmt.className = 'right';
        tdAmt.textContent = fmtMoney(row.cents);

        tr.append(tdCat, tdPct, tdBar, tdAmt);
        resultsBody.appendChild(tr);
      }

      // Totals
      const totalCents = merged.reduce((t,r) => t + r.cents, 0);
      totalPct.textContent = "100%";
      totalAmt.textContent = fmtMoney(totalCents);

      // Contacts UI
      const ctr = CONTACTS[ward];
      cName.textContent = ctr?.name || '—';
      cEmail.textContent = ctr?.email || '—';
      ccListEl.textContent = QUERY_CC.join(', ');

      // Tools & shareables
      const link = buildDeepLink(ward, amountCents);
      linkBtn.href = link;

      // Email subject + body (no line-by-line figures; image instead)
      const subject = `Question re 2026 plan — ${ward} property tax breakdown`;
      const greeting = `Hello ${ctr?.name || "Councillor"}, and ${MAYOR.name},`;
      const lines = [
        greeting,
        "",
        `My annual property tax bill for ${ward} is ${fmtMoney(amountCents)}.`,
        "Could you please share the plan for 2026 — including priorities, any changes in allocations, and the public engagement timeline?",
        "",
        "I've attached an image of the breakdown (12 budget categories) for your reference.",
        `Shareable link: ${link}`,
        "",
        "Thank you,"
      ];
      const body = lines.join('\n');

      emailBtn.onclick = () => {
        const to = [ctr?.email || '', MAYOR.email].filter(Boolean);
        const mailto = buildMailto(to, QUERY_CC, subject, body);
        try { window.location.href = mailto; } catch { window.open(mailto, '_blank'); }
      };

      copyEmailBtn.onclick = async () => {
        try{
          await navigator.clipboard.writeText(`Subject: ${subject}\n\n${body}`);
          showMsg("Email text copied to clipboard.", false);
        }catch{
          showMsg("Copy failed. You can select and copy manually.", true);
        }
      };

      copyAddrsBtn.onclick = async () => {
        const to = [ctr?.email || '', MAYOR.email].filter(Boolean).join(', ');
        const cc = QUERY_CC.join(', ');
        const text = `To: ${to}\nCc: ${cc}`;
        try{
          await navigator.clipboard.writeText(text);
          showMsg("Email addresses copied.", false);
        }catch{
          showMsg("Copy failed. You can select and copy manually.", true);
        }
      };

      shareBtn.onclick = () => {
        const shareUrl = encodeURIComponent(link);
        const fb = `https://www.facebook.com/sharer/sharer.php?u=${shareUrl}`;
        window.open(fb, 'fbshare', 'width=640,height=600');
      };

      // PNG export button
      pngBtn.onclick = async () => {
        try{
          const { blob } = await generateTablePNG(ward, lastMergedForImage || merged, lastTotalCents || totalCents);
          const fname = `arcadia-tax-breakdown-${ward.replace(/\s+/g,'-').toLowerCase()}.png`;
          downloadBlob(blob, fname);
          showMsg("Image downloaded. Attach it to your email before sending.", false);
        }catch(e){
          showMsg("Could not generate image on this device.", true);
        }
      };

      out.classList.remove('hidden');
      showMsg("", false, true);

      // Persist for image export
      lastMergedForImage = merged;
      lastTotalCents = totalCents;
      lastWardName = ward;

      // Persist last selections
      localStorage.setItem('tax:lastWard', ward);
      localStorage.setItem('tax:lastAmt', amountCents);
      history.replaceState(null, '', link);
    }

    function showMsg(text, isError=false, clear=false){
      if (clear || !text){
        msg.classList.add('hidden');
        msg.textContent = '';
        return;
      }
      msg.textContent = text;
      msg.className = (isError ? 'warn' : 'info');
    }

    // Event wiring
    calcBtn.addEventListener('click', (e) => { e.preventDefault(); computeAndRender(); });
    resetBtn.addEventListener('click', (e) => {
      e.preventDefault();
      amtInput.value = '';
      out.classList.add('hidden');
      showMsg("", false, true);
      const url = new URL(window.location.href);
      url.searchParams.delete('ward'); url.searchParams.delete('amount'); url.searchParams.delete('currency');
      history.replaceState(null, '', url.toString());
    });

    // Load from deep link or last selections
    (function init(){
      const url = new URL(window.location.href);
      const qWard = url.searchParams.get('ward');
      const qAmt = url.searchParams.get('amount');
      const lastWard = localStorage.getItem('tax:lastWard');
      const lastAmt  = localStorage.getItem('tax:lastAmt');

      function resolveWardName(name){
        if (!name) return null;
        if (WARD_DATA[name]) return name;
        if (LEGACY_WARD_ALIASES[name]) return LEGACY_WARD_ALIASES[name];
        return null;
      }

      const fromQuery = resolveWardName(qWard);
      const fromStorage = resolveWardName(lastWard);

      if (fromQuery) wardSel.value = fromQuery;
      else if (fromStorage) wardSel.value = fromStorage;

      if (qAmt){
        amtInput.value = qAmt;
        computeAndRender();
      } else if (lastAmt){
        amtInput.value = (Number(lastAmt)/100).toString();
      }
    })();
  </script>
</body>
</html>
